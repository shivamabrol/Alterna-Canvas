import { Component, EventEmitter, Input, Output } from "@angular/core";
import { DayPilot } from "./core/daypilot-core";
import { optHash, rand, EventDiff } from "./util";
import * as i0 from "@angular/core";
export class DayPilotSchedulerComponent {
    constructor() {
        this.viewChange = new EventEmitter();
        this._requestUpdateFull = false;
        this._requestUpdateEvents = false;
        this._requestViewChange = false;
        this._eventDiff = new EventDiff();
        this._visibleRange = { start: new DayPilot.Date(), end: new DayPilot.Date() };
        this._hashOptions = "";
        this._eventsSet = false;
        this._events = [];
        this._id = "dp_" + new Date().getTime() + rand();
    }
    //@Input() events: DayPilot.EventData[];
    get events() {
        return this._events;
    }
    set events(value) {
        this._eventsSet = true;
        this._events = value;
    }
    get id() {
        return this._id;
    }
    ngOnInit() {
    }
    ngOnDestroy() {
        this.dispose();
    }
    ngAfterViewInit() {
        // not sure why this was called here, it shouldn't be
        // this.dispose();
        this.control = new DayPilot.Scheduler(this.id);
        let control = this.control;
        control.internal.enableAngular2();
        this.updateOptions();
        this.updateEvents();
        this._requestUpdateFull = false; // config just loaded and calling init(), no need to call update again
        this._requestUpdateEvents = false; // config just loaded and calling init(), no need to call update again
        this.control.init();
    }
    ngDoCheck() {
        if (!this.control) {
            return;
        }
        this.updateOptions();
        this.updateEvents();
        let control = this.control;
        if (this._requestUpdateFull) {
            this.control.update();
            control.internal.postInit();
            this._requestUpdateFull = false;
            this._requestUpdateEvents = false;
        }
        else if (this._requestUpdateEvents) {
            this.control.update({ "events": this.events });
            this._requestUpdateEvents = false;
        }
        if (this._requestViewChange) {
            this._requestViewChange = false;
            let args = {};
            args.visibleRangeChanged = this._visibleRange.start !== this.control.visibleStart() || this._visibleRange.end !== this.control.visibleEnd();
            this._visibleRange.start = this.control.visibleStart();
            this._visibleRange.end = this.control.visibleEnd();
            this.viewChange.emit(args);
        }
    }
    dispose() {
        if (this.control) {
            this.control.dispose();
            //@ts-ignore
            this.control = null;
        }
    }
    updateOptions() {
        let hash = optHash(this.config);
        if (hash !== this._hashOptions) {
            let control = this.control;
            if (this.config && this.config.resources) {
                control.internal.resourcesFromAttr();
            }
            if (control.internal.skipUpdate()) {
                control.internal.skipped();
            }
            else {
                control.internal.loadOptions(this.config);
                this._requestUpdateFull = true;
                this._requestViewChange = true;
            }
        }
        this._hashOptions = hash;
    }
    updateEvents() {
        if (!this._eventsSet) {
            return;
        }
        let diff = this._eventDiff.diff(this.events);
        let control = this.control;
        control.internal.eventsFromAttr();
        if (control.internal.skipUpdate()) {
            control.internal.skipped();
            //this._hashEvents = hash;
            return;
        }
        let maxInlineChanges = 10;
        if (diff.changeCount === 0 && this.events === control.events.list) {
            return;
        }
        if (diff.changeCount < maxInlineChanges && this.events === control.events.list) {
            diff.add.forEach(function (data) {
                control.events.add(new DayPilot.Event(data), null, { "renderOnly": true });
            });
            diff.modify.forEach(function (data) {
                control.events.update(new DayPilot.Event(data));
            });
            diff.remove.forEach(function (id) {
                let e = control.events.find(id);
                if (e) {
                    control.events.remove(e);
                }
            });
            control.internal.evImmediateRefresh();
            // make sure it's synced, after inline update
            //control.events.list = this.events;
        }
        else {
            control.events.list = this.events;
            this._requestUpdateEvents = true;
        }
    }
}
DayPilotSchedulerComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: DayPilotSchedulerComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });
DayPilotSchedulerComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.1.3", type: DayPilotSchedulerComponent, selector: "daypilot-scheduler", inputs: { config: "config", events: "events" }, outputs: { viewChange: "viewChange" }, ngImport: i0, template: `
    <div id='{{id}}'></div>`, isInline: true, styles: [""] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: DayPilotSchedulerComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'daypilot-scheduler',
                    template: `
    <div id='{{id}}'></div>`,
                    styles: [``]
                }]
        }], propDecorators: { viewChange: [{
                type: Output
            }], config: [{
                type: Input
            }], events: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF5cGlsb3Qtc2NoZWR1bGVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL2RheXBpbG90LXByby1hbmd1bGFyL3NyYy9saWIvZGF5cGlsb3Qtc2NoZWR1bGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWdCLFNBQVMsRUFBVyxZQUFZLEVBQUUsS0FBSyxFQUFxQixNQUFNLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDaEgsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQzlDLE9BQU8sRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBQyxNQUFNLFFBQVEsQ0FBQzs7QUFRaEQsTUFBTSxPQUFPLDBCQUEwQjtJQU52QztRQVNZLGVBQVUsR0FBZ0MsSUFBSSxZQUFZLEVBQWlCLENBQUM7UUFFOUUsdUJBQWtCLEdBQVksS0FBSyxDQUFDO1FBQ3BDLHlCQUFvQixHQUFZLEtBQUssQ0FBQztRQUN0Qyx1QkFBa0IsR0FBWSxLQUFLLENBQUM7UUFDcEMsZUFBVSxHQUFHLElBQUksU0FBUyxFQUFFLENBQUM7UUFDN0Isa0JBQWEsR0FBRyxFQUFDLEtBQUssRUFBRSxJQUFJLFFBQVEsQ0FBQyxJQUFJLEVBQUUsRUFBRSxHQUFHLEVBQUUsSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFLEVBQUMsQ0FBQztRQUN2RSxpQkFBWSxHQUFXLEVBQUUsQ0FBQztRQUMxQixlQUFVLEdBQVksS0FBSyxDQUFDO1FBRTVCLFlBQU8sR0FBeUIsRUFBRSxDQUFDO1FBYW5DLFFBQUcsR0FBVyxLQUFLLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxJQUFJLEVBQUUsQ0FBQztLQWlJN0Q7SUE3SUMsd0NBQXdDO0lBRXhDLElBQVcsTUFBTTtRQUNmLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN0QixDQUFDO0lBRUQsSUFD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QUFDO1NBQ2xDO0lBQ0gsQ0FBQzs7dUhBMUpVLDBCQUEwQjsyR0FBMUIsMEJBQTBCLGlKQUozQjs0QkFDZ0I7MkZBR2YsMEJBQTBCO2tCQU50QyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxvQkFBb0I7b0JBQzlCLFFBQVEsRUFBRTs0QkFDZ0I7b0JBQzFCLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQztpQkFDYjs4QkFJVyxVQUFVO3NCQUFuQixNQUFNO2dCQUNFLE1BQU07c0JBQWQsS0FBSztnQkFpQkssTUFBTTtzQkFEaEIsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7QWZ0ZXJWaWV3SW5pdCwgQ29tcG9uZW50LCBEb0NoZWNrLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkRlc3Ryb3ksIE9uSW5pdCwgT3V0cHV0fSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHtEYXlQaWxvdH0gZnJvbSBcIi4vY29yZS9kYXlwaWxvdC1jb3JlXCI7XG5pbXBvcnQge29wdEhhc2gsIHJhbmQsIEV2ZW50RGlmZn0gZnJvbSBcIi4vdXRpbFwiO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdkYXlwaWxvdC1zY2hlZHVsZXInLFxuICB0ZW1wbGF0ZTogYFxuICAgIDxkaXYgaWQ9J3t7aWR9fSc+PC9kaXY+YCxcbiAgc3R5bGVzOiBbYGBdXG59KVxuZXhwb3J0IGNsYXNzIERheVBpbG90U2NoZWR1bGVyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQsIERvQ2hlY2sge1xuXG4gIHB1YmxpYyBjb250cm9sITogRGF5UGlsb3QuU2NoZWR1bGVyO1xuICBAT3V0cHV0KCkgdmlld0NoYW5nZTogRXZlbnRFbWl0dGVyPERheVBpbG90LkRhdGU+ID0gbmV3IEV2ZW50RW1pdHRlcjxEYXlQaWxvdC5EYXRlPigpO1xuICBASW5wdXQoKSBjb25maWc6IGFueTtcbiAgcHJpdmF0ZSBfcmVxdWVzdFVwZGF0ZUZ1bGw6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBfcmVxdWVzdFVwZGF0ZUV2ZW50czogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIF9yZXF1ZXN0Vmlld0NoYW5nZTogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIF9ldmVudERpZmYgPSBuZXcgRXZlbnREaWZmKCk7XG4gIHByaXZhdGUgX3Zpc2libGVSYW5nZSA9IHtzdGFydDogbmV3IERheVBpbG90LkRhdGUoKSwgZW5kOiBuZXcgRGF5UGlsb3QuRGF0ZSgpfTtcbiAgcHJpdmF0ZSBfaGFzaE9wdGlvbnM6IHN0cmluZyA9IFwiXCI7XG4gIHByaXZhdGUgX2V2ZW50c1NldDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIHByaXZhdGUgX2V2ZW50czogRGF5UGlsb3QuRXZlbnREYXRhW10gPSBbXTtcbiAgLy9ASW5wdXQoKSBldmVudHM6IERheVBpbG90LkV2ZW50RGF0YVtdO1xuXG4gIHB1YmxpYyBnZXQgZXZlbnRzKCk6IERheVBpbG90LkV2ZW50RGF0YVtdIHtcbiAgICByZXR1cm4gdGhpcy5fZXZlbnRzO1xuICB9XG5cbiAgQElucHV0KClcbiAgcHVibGljIHNldCBldmVudHModmFsdWU6IERheVBpbG90LkV2ZW50RGF0YVtdKSB7XG4gICAgdGhpcy5fZXZlbnRzU2V0ID0gdHJ1ZTtcbiAgICB0aGlzLl9ldmVudHMgPSB2YWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgX2lkOiBzdHJpbmcgPSBcImRwX1wiICsgbmV3IERhdGUoKS5nZXRUaW1lKCkgKyByYW5kKCk7XG5cbiAgZ2V0IGlkKCkge1xuICAgIHJldHVybiB0aGlzLl9pZDtcbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5kaXNwb3NlKCk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG5cbiAgICAvLyBub3Qgc3VyZSB3aHkgdGhpcyB3YXMgY2FsbGVkIGhlcmUsIGl0IHNob3VsZG4ndCBiZVxuICAgIC8vIHRoaXMuZGlzcG9zZSgpO1xuXG4gICAgdGhpcy5jb250cm9sID0gbmV3IERheVBpbG90LlNjaGVkdWxlcih0aGlzLmlkKTtcbiAgICBsZXQgY29udHJvbDogYW55ID0gdGhpcy5jb250cm9sO1xuICAgIGNvbnRyb2wuaW50ZXJuYWwuZW5hYmxlQW5ndWxhcjIoKTtcbiAgICB0aGlzLnVwZGF0ZU9wdGlvbnMoKTtcbiAgICB0aGlzLnVwZGF0ZUV2ZW50cygpO1xuICAgIHRoaXMuX3JlcXVlc3RVcGRhdGVGdWxsID0gZmFsc2U7IC8vIGNvbmZpZyBqdXN0IGxvYWRlZCBhbmQgY2FsbGluZyBpbml0KCksIG5vIG5lZWQgdG8gY2FsbCB1cGRhdGUgYWdhaW5cbiAgICB0aGlzLl9yZXF1ZXN0VXBkYXRlRXZlbnRzID0gZmFsc2U7IC8vIGNvbmZpZyBqdXN0IGxvYWRlZCBhbmQgY2FsbGluZyBpbml0KCksIG5vIG5lZWQgdG8gY2FsbCB1cGRhdGUgYWdhaW5cbiAgICB0aGlzLmNvbnRyb2wuaW5pdCgpO1xuICB9XG5cbiAgbmdEb0NoZWNrKCk6IHZvaWQge1xuXG4gICAgaWYgKCF0aGlzLmNvbnRyb2wpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVPcHRpb25zKCk7XG4gICAgdGhpcy51cGRhdGVFdmVudHMoKTtcblxuICAgIGxldCBjb250cm9sOiBhbnkgPSB0aGlzLmNvbnRyb2w7XG5cbiAgICBpZiAodGhpcy5fcmVxdWVzdFVwZGF0ZUZ1bGwpIHtcbiAgICAgIHRoaXMuY29udHJvbC51cGRhdGUoKTtcbiAgICAgIGNvbnRyb2wuaW50ZXJuYWwucG9zdEluaXQoKTtcbiAgICAgIHRoaXMuX3JlcXVlc3RVcGRhdGVGdWxsID0gZmFsc2U7XG4gICAgICB0aGlzLl9yZXF1ZXN0VXBkYXRlRXZlbnRzID0gZmFsc2U7XG4gICAgfSBlbHNlIGlmICh0aGlzLl9yZXF1ZXN0VXBkYXRlRXZlbnRzKSB7XG4gICAgICB0aGlzLmNvbnRyb2wudXBkYXRlKHtcImV2ZW50c1wiOiB0aGlzLmV2ZW50c30pO1xuICAgICAgdGhpcy5fcmVxdWVzdFVwZGF0ZUV2ZW50cyA9IGZhbHNlO1xuICAgIH1cblxuICAgIGlmICh0aGlzLl9yZXF1ZXN0Vmlld0NoYW5nZSkge1xuICAgICAgdGhpcy5fcmVxdWVzdFZpZXdDaGFuZ2UgPSBmYWxzZTtcbiAgICAgIGxldCBhcmdzOiBhbnkgPSB7fTtcbiAgICAgIGFyZ3MudmlzaWJsZVJhbmdlQ2hhbmdlZCA9IHRoaXMuX3Zpc2libGVSYW5nZS5zdGFydCAhPT0gdGhpcy5jb250cm9sLnZpc2libGVTdGFydCgpIHx8IHRoaXMuX3Zpc2libGVSYW5nZS5lbmQgIT09IHRoaXMuY29udHJvbC52aXNpYmxlRW5kKCk7XG4gICAgICB0aGlzLl92aXNpYmxlUmFuZ2Uuc3RhcnQgPSB0aGlzLmNvbnRyb2wudmlzaWJsZVN0YXJ0KCk7XG4gICAgICB0aGlzLl92aXNpYmxlUmFuZ2UuZW5kID0gdGhpcy5jb250cm9sLnZpc2libGVFbmQoKTtcbiAgICAgIHRoaXMudmlld0NoYW5nZS5lbWl0KGFyZ3MpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGlzcG9zZSgpIHtcbiAgICBpZiAodGhpcy5jb250cm9sKSB7XG4gICAgICB0aGlzLmNvbnRyb2wuZGlzcG9zZSgpO1xuICAgICAgLy9AdHMtaWdub3JlXG4gICAgICB0aGlzLmNvbnRyb2wgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlT3B0aW9ucygpOiB2b2lkIHtcbiAgICBsZXQgaGFzaCA9IG9wdEhhc2godGhpcy5jb25maWcpO1xuICAgIGlmIChoYXNoICE9PSB0aGlzLl9oYXNoT3B0aW9ucykge1xuICAgICAgbGV0IGNvbnRyb2w6IGFueSA9IHRoaXMuY29udHJvbDtcblxuICAgICAgaWYgKHRoaXMuY29uZmlnICYmIHRoaXMuY29uZmlnLnJlc291cmNlcykge1xuICAgICAgICBjb250cm9sLmludGVybmFsLnJlc291cmNlc0Zyb21BdHRyKCk7XG4gICAgICB9XG5cbiAgICAgIGlmIChjb250cm9sLmludGVybmFsLnNraXBVcGRhdGUoKSkge1xuICAgICAgICBjb250cm9sLmludGVybmFsLnNraXBwZWQoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnRyb2wuaW50ZXJuYWwubG9hZE9wdGlvbnModGhpcy5jb25maWcpO1xuICAgICAgICB0aGlzLl9yZXF1ZXN0VXBkYXRlRnVsbCA9IHRydWU7XG4gICAgICAgIHRoaXMuX3JlcXVlc3RWaWV3Q2hhbmdlID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgIH1cbiAgICB0aGlzLl9oYXNoT3B0aW9ucyA9IGhhc2g7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUV2ZW50cygpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuX2V2ZW50c1NldCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBkaWZmID0gdGhpcy5fZXZlbnREaWZmLmRpZmYodGhpcy5ldmVudHMpO1xuXG4gICAgbGV0IGNvbnRyb2w6IGFueSA9IHRoaXMuY29udHJvbDtcbiAgICBjb250cm9sLmludGVybmFsLmV2ZW50c0Zyb21BdHRyKCk7XG5cbiAgICBpZiAoY29udHJvbC5pbnRlcm5hbC5za2lwVXBkYXRlKCkpIHtcbiAgICAgIGNvbnRyb2wuaW50ZXJuYWwuc2tpcHBlZCgpO1xuICAgICAgLy90aGlzLl9oYXNoRXZlbnRzID0gaGFzaDtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgbWF4SW5saW5lQ2hhbmdlcyA9IDEwO1xuXG4gICAgaWYgKGRpZmYuY2hhbmdlQ291bnQgPT09IDAgJiYgdGhpcy5ldmVudHMgPT09IGNvbnRyb2wuZXZlbnRzLmxpc3QpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGRpZmYuY2hhbmdlQ291bnQgPCBtYXhJbmxpbmVDaGFuZ2VzICYmIHRoaXMuZXZlbnRzID09PSBjb250cm9sLmV2ZW50cy5saXN0KSB7XG4gICAgICBkaWZmLmFkZC5mb3JFYWNoKGZ1bmN0aW9uIChkYXRhOiBhbnkpIHtcbiAgICAgICAgY29udHJvbC5ldmVudHMuYWRkKG5ldyBEYXlQaWxvdC5FdmVudChkYXRhKSwgbnVsbCwge1wicmVuZGVyT25seVwiOiB0cnVlfSk7XG4gICAgICB9KTtcbiAgICAgIGRpZmYubW9kaWZ5LmZvckVhY2goZnVuY3Rpb24gKGRhdGE6IGFueSkge1xuICAgICAgICBjb250cm9sLmV2ZW50cy51cGRhdGUobmV3IERheVBpbG90LkV2ZW50KGRhdGEpKTtcbiAgICAgIH0pO1xuICAgICAgZGlmZi5yZW1vdmUuZm9yRWFjaChmdW5jdGlvbiAoaWQ6IGFueSkge1xuICAgICAgICBsZXQgZSA9IGNvbnRyb2wuZXZlbnRzLmZpbmQoaWQpO1xuICAgICAgICBpZiAoZSkge1xuICAgICAgICAgIGNvbnRyb2wuZXZlbnRzLnJlbW92ZShlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBjb250cm9sLmludGVybmFsLmV2SW1tZWRpYXRlUmVmcmVzaCgpO1xuICAgICAgLy8gbWFrZSBzdXJlIGl0J3Mgc3luY2VkLCBhZnRlciBpbmxpbmUgdXBkYXRlXG4gICAgICAvL2NvbnRyb2wuZXZlbnRzLmxpc3QgPSB0aGlzLmV2ZW50cztcbiAgICB9IGVsc2Uge1xuICAgICAgY29udHJvbC5ldmVudHMubGlzdCA9IHRoaXMuZXZlbnRzO1xuICAgICAgdGhpcy5fcmVxdWVzdFVwZGF0ZUV2ZW50cyA9IHRydWU7XG4gICAgfVxuICB9XG59XG4iXX0=